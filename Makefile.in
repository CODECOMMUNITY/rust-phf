VPATH=%VPATH%

RUSTC ?= rustc
RUSTDOC ?= rustdoc
RUSTFLAGS ?= -O
HOST_RUSTFLAGS ?= -O


PHF_SRC := $(VPATH)/src/phf.rs
PHF_MAC_SRC := $(VPATH)/src/phf_mac.rs
PHF_TEST_SRC := $(VPATH)/src/test.rs

all: phf.dummy phf_host.dummy phf_mac.dummy

phf.dummy: $(PHF_SRC)
	$(RUSTC) $(RUSTFLAGS) $< --out-dir .
	touch $@

# phf_mac depends on phf, so it must be built once for
# the target platform, and again for the host platform.
phf_host.dummy: $(PHF_SRC)
	mkdir -p host
	$(RUSTC) $(HOST_RUSTFLAGS) $< --out-dir host
	touch $@

phf_mac.dummy: $(PHF_MAC_SRC) phf_host.dummy
	$(RUSTC) $(HOST_RUSTFLAGS) -L host $< --out-dir .
	touch $@

check: phf-test
	./phf-test

phf-test: $(PHF_TEST_SRC) phf.dummy phf_mac.dummy
	$(RUSTC) $(RUSTFLAGS) -L . $< -o $@ --test

clean:
	rm -rf host
	rm -f *.o *.a *.so *.dylib *.rlib *.dll *.dummy *.exe *-test

.PHONY: all check clean
